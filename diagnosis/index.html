<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è‡ªå·±ç†è§£æ¤œå®šï½œRASIN</title>
  <link rel="stylesheet" href="./diagnosis.css" />
  <link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" type="image/png" href="/favicon.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
</head>
<body>
  <div class="bg"></div>

  <header class="topbar">
    <a class="brand" href="/">
      <span class="brand__dot"></span>
      <span class="brand__text">RASIN</span>
    </a>

    <a class="pill" href="../index.html">LPã¸æˆ»ã‚‹</a>
  </header>

  <main class="wrap">
    <!-- Intro -->
    <section id="intro" class="screen is-active">
      <div class="hero">
        <h1 class="hero__title">
          <span class="hero__titleGlow">è‡ªå·±ç†è§£æ¤œå®š</span><br />
          <span class="hero__titleSub">ã‚ãªãŸã®ã€Œè‡ªå·±ç†è§£ãƒ¬ãƒ™ãƒ«ã€ã‚’100ç‚¹æº€ç‚¹ã§å¯è¦–åŒ–</span>
        </h1>

        <div class="glass card">
          <div class="card__icon">ğŸ§­</div>
          <div class="card__body">
            <p class="muted">
              æ‰€è¦æ™‚é–“ï¼š2ã€œ5åˆ†ï¼å…¨28å•<br />
              å›ç­”ã¯é€”ä¸­ä¿å­˜ãªã—ï¼ˆã™ãçµ‚ã‚ã‚Šã¾ã™ï¼‰
            </p>
            <ul class="bullets">
              <li>è‡ªå·±èªçŸ¥ï¼ˆ1ã€œ7ï¼‰</li>
              <li>è¡Œå‹•ãƒ™ãƒ¼ã‚¹ï¼ˆé¸æŠå¼ï¼‰</li>
              <li>ä¾¡å€¤è¦³ã®ä¸€è²«æ€§ï¼ˆA/Bï¼‰</li>
              <li>è¨€èªåŒ–ãƒã‚§ãƒƒã‚¯ï¼ˆçŸ­æ–‡ï¼‰</li>
            </ul>

            <button id="startBtn" class="btn btn--primary btn--lg">
              è¨ºæ–­ã‚’é–‹å§‹ã™ã‚‹
              <span class="btn__arrow">â†’</span>
            </button>

            <p class="fine">
              â€»çµæœã¯ã‚ãã¾ã§è‡ªå·±ç†è§£ã®ç›®å®‰ã§ã™ã€‚æ¡ç”¨å¯å¦ã‚’åˆ¤æ–­ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Quiz -->
    <section id="quiz" class="screen">
      <div class="progress">
        <div class="progress__top">
          <div class="progress__label">
            <span id="sectionLabel">ã‚»ã‚¯ã‚·ãƒ§ãƒ³A</span>
            <span class="muted">è³ªå• <span id="qIndex">1</span>/<span id="qTotal">28</span></span>
          </div>
        </div>
        <div class="progress__bar">
          <div id="progressFill" class="progress__fill"></div>
        </div>
      </div>

      <div class="glass quizCard">
        <h2 id="questionText" class="qtitle">è³ªå•ãŒå…¥ã‚Šã¾ã™</h2>

        <div id="choices" class="choices"></div>

        <div class="nav">
          <button id="backBtn" class="btn btn--ghost">â† æˆ»ã‚‹</button>
          <button id="nextBtn" class="btn btn--primary">
            æ¬¡ã¸ <span class="btn__arrow">â†’</span>
          </button>
        </div>
      </div>
    </section>

    <!-- Result -->
    <section id="result" class="screen">
      <div class="glass resultCard">
        <h2 class="resultTitle">è¨ºæ–­çµæœ</h2>

        <div class="scoreRow">
          <div class="score">
            <div class="score__num"><span id="scoreNum">0</span><span class="score__unit">/100</span></div>
            <div class="muted" id="gradeText">åˆ¤å®šï¼š---</div>
          </div>
          <div class="meter">
            <div class="meter__bar">
              <div id="meterFill" class="meter__fill"></div>
            </div>
            <div class="meter__labels">
              <span>0</span><span>50</span><span>100</span>
            </div>
          </div>
        </div>

        <div class="grid">
          <div class="glass mini">
            <div class="mini__title">å¼·ã¿</div>
            <ul id="resultStrength" class="mini__list"></ul>
          </div>
          <div class="glass mini">
            <div class="mini__title">æ¬¡ã«ä¼¸ã°ã™</div>
            <ul id="resultNext" class="mini__list"></ul>
          </div>
        </div>

        <div class="cta">
          <div class="cta__text">
            <div class="cta__title">çµæœã‚’ã‚‚ã¨ã«ã€ç„¡æ–™ã§ã€Œå°±æ´»ã®è»¸ã€ã‚’æ•´ç†ã—ã‚ˆã†</div>
            <div class="muted">ã‚ãªãŸã®å›ç­”å†…å®¹ã«åˆã‚ã›ã¦ã€æ¬¡ã®ä¸€æ‰‹ã‚’ä¸€ç·’ã«æ±ºã‚ã¾ã™ã€‚</div>
          </div>
          <a class="btn btn--line btn--lg" href="https://lin.ee/MR1jOBx" target="_blank" rel="noopener">
            LINEã§ç„¡æ–™ç›¸è«‡ã™ã‚‹
            <span class="btn__arrow">â†’</span>
          </a>
        </div>

        <div class="nav nav--center">
          <button id="retryBtn" class="btn btn--ghost">ã‚‚ã†ä¸€åº¦è¨ºæ–­ã™ã‚‹</button>
          <a class="btn btn--ghost" href="/">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
        </div>
      </div>
    </section>
  </main>

  <script src="./diagnosis.js"></script>
  <!-- Firebase SDKã®èª­ã¿è¾¼ã¿ -->
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
      }
    }
  </script>

  <script type="module">
    import { initializeApp } from "firebase/app";
    import { getAuth, signInAnonymously } from "firebase/auth";
    import { getFirestore, collection, addDoc, serverTimestamp } from "firebase/firestore";

    // 1. FirebaseåˆæœŸåŒ–ï¼ˆç©ºæ–‡å­—ã®ã¾ã¾ç’°å¢ƒãŒã‚­ãƒ¼ã‚’æ³¨å…¥ã—ã¾ã™ï¼‰
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'rasin-app';

    // 2. åŒ¿åèªè¨¼
    const initAuth = async () => {
        try {
            await signInAnonymously(auth);
        } catch (error) {
            console.error("Auth Error:", error);
        }
    };
    initAuth();

    /**
     * Slackã¸ã®é€šçŸ¥ï¼ˆWebhookã‚’ä½¿ç”¨ï¼‰
     */
    async function sendSlackNotification(data) {
        const SLACK_WEBHOOK_URL = "YOUR_SLACK_WEBHOOK_URL_HERE"; // â˜…ã“ã“ã«Slackã®URLã‚’å…¥ã‚Œã‚‹
        
        const message = {
            text: "ğŸ”” *è‡ªå·±ç†è§£æ¤œå®šã®å—æ¤œå®Œäº†é€šçŸ¥*",
            attachments: [{
                color: "#1a365d",
                fields: [
                    { title: "ã‚¹ã‚³ã‚¢", value: `${data.score}ç‚¹`, short: true },
                    { title: "åˆ¤å®š", value: data.grade, short: true },
                    { title: "å—æ¤œæ—¥æ™‚", value: new Date().toLocaleString(), short: false }
                ]
            }]
        };

        try {
            await fetch(SLACK_WEBHOOK_URL, {
                method: 'POST',
                body: JSON.stringify(message),
                mode: 'no-cors' 
            });
        } catch (e) {
            console.warn("Slacké€šçŸ¥å¤±æ•—");
        }
    }

    /**
     * è¨ºæ–­å®Œäº†æ™‚ã«çµæœã‚’DBã«ä¿å­˜ã™ã‚‹é–¢æ•°
     * diagnosis.jsã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’æƒ³å®š
     */
    window.saveDiagnosisResult = async function(score, grade) {
        const user = auth.currentUser;
        if (!user) return;

        const data = {
            uid: user.uid,
            score: score,
            grade: grade,
            createdAt: serverTimestamp(),
            device: navigator.userAgent
        };

        try {
            // DBä¿å­˜
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'diagnoses'), data);
            // Slacké€šçŸ¥
            await sendSlackNotification(data);
            console.log("Result saved successfully.");
        } catch (e) {
            console.error("Save Error:", e);
        }
    };
  </script>
</body>
</body>
</html>
